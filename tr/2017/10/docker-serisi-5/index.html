<!doctype html><html lang=tr dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Docker Serisi #5 -- Docker Machine & Swarm Bölüm 1 | Alper Kanat</title><meta name=keywords content="yazılım,docker,docker serisi,container,sanallaştırma,linux,devops"><meta name=description content="bölüme hoşgeldiniz! 🤘🏻 Serinin önceki bölümlerine ulaşmak için aşağıdaki bağlantıları kullanabilirsiniz: Docker Serisi #1 Docker Serisi #2 — Docker Engine Bölüm 1 Docker Serisi #3 — Docker Engine Bölüm 2 Docker Serisi #4 — Docker Compose Serinin bu bölümünde Docker Machine’den ve teknoloji camiasının bu sıralar çok sık duyduğu Docker Swarm’dan bahsedeceğim. Swarm konusu derya deniz olduğundan konuyu 2 ayrı bölüm halinde işleyeceğim. İlk bölümde Docker Machine’den bahsedip Swarm’a giriş yapacağız."><meta name=author content><link rel=canonical href=https://alperkan.at/tr/2017/10/docker-serisi-5/><link crossorigin=anonymous href=/assets/css/stylesheet.min.2d6dbfc6e0f8a1db1c9d082a76dc11d094328cf63f247bbc2421dfaa7f2bb170.css integrity="sha256-LW2/xuD4odscnQgqdtwR0JQyjPY/JHu8JCHfqn8rsXA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://alperkan.at/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://alperkan.at/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://alperkan.at/favicon-32x32.png><link rel=apple-touch-icon href=https://alperkan.at/apple-touch-icon.png><link rel=mask-icon href=https://alperkan.at/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.102.3"><link rel=alternate hreflang=tr href=https://alperkan.at/tr/2017/10/docker-serisi-5/><script async src="https://www.googletagmanager.com/gtag/js?id=G-SDT9Y68PM3"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-SDT9Y68PM3",{anonymize_ip:!1})}</script><meta property="og:title" content="Docker Serisi #5 -- Docker Machine & Swarm Bölüm 1"><meta property="og:description" content="bölüme hoşgeldiniz! 🤘🏻 Serinin önceki bölümlerine ulaşmak için aşağıdaki bağlantıları kullanabilirsiniz: Docker Serisi #1 Docker Serisi #2 — Docker Engine Bölüm 1 Docker Serisi #3 — Docker Engine Bölüm 2 Docker Serisi #4 — Docker Compose Serinin bu bölümünde Docker Machine’den ve teknoloji camiasının bu sıralar çok sık duyduğu Docker Swarm’dan bahsedeceğim. Swarm konusu derya deniz olduğundan konuyu 2 ayrı bölüm halinde işleyeceğim. İlk bölümde Docker Machine’den bahsedip Swarm’a giriş yapacağız."><meta property="og:type" content="article"><meta property="og:url" content="https://alperkan.at/tr/2017/10/docker-serisi-5/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-10-30T00:00:00+00:00"><meta property="article:modified_time" content="2021-04-26T00:02:59+03:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Docker Serisi #5 -- Docker Machine & Swarm Bölüm 1"><meta name=twitter:description content="bölüme hoşgeldiniz! 🤘🏻 Serinin önceki bölümlerine ulaşmak için aşağıdaki bağlantıları kullanabilirsiniz: Docker Serisi #1 Docker Serisi #2 — Docker Engine Bölüm 1 Docker Serisi #3 — Docker Engine Bölüm 2 Docker Serisi #4 — Docker Compose Serinin bu bölümünde Docker Machine’den ve teknoloji camiasının bu sıralar çok sık duyduğu Docker Swarm’dan bahsedeceğim. Swarm konusu derya deniz olduğundan konuyu 2 ayrı bölüm halinde işleyeceğim. İlk bölümde Docker Machine’den bahsedip Swarm’a giriş yapacağız."><script type=application/ld+json>
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://alperkan.at/tr/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Docker Serisi #5 -- Docker Machine \u0026 Swarm Bölüm 1",
      "item": "https://alperkan.at/tr/2017/10/docker-serisi-5/"
    }
  ]
}
</script><script type=application/ld+json>
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Docker Serisi #5 -- Docker Machine \u0026 Swarm Bölüm 1",
  "name": "Docker Serisi #5 -- Docker Machine \u0026 Swarm Bölüm 1",
  "description": "bölüme hoşgeldiniz! 🤘🏻 Serinin önceki bölümlerine ulaşmak için aşağıdaki bağlantıları kullanabilirsiniz: Docker Serisi #1 Docker Serisi #2 — Docker Engine Bölüm 1 Docker Serisi #3 — Docker Engine Bölüm 2 Docker Serisi #4 — Docker Compose Serinin bu bölümünde Docker Machine’den ve teknoloji camiasının bu sıralar çok sık duyduğu Docker Swarm’dan bahsedeceğim. Swarm konusu derya deniz olduğundan konuyu 2 ayrı bölüm halinde işleyeceğim. İlk bölümde Docker Machine’den bahsedip Swarm’a giriş yapacağız.",
  "keywords": [
    "yazılım", "docker", "docker serisi", "container", "sanallaştırma", "linux", "devops"
  ],
  "articleBody": " bölüme hoşgeldiniz! 🤘🏻 Serinin önceki bölümlerine ulaşmak için aşağıdaki bağlantıları kullanabilirsiniz: Docker Serisi #1 Docker Serisi #2 — Docker Engine Bölüm 1 Docker Serisi #3 — Docker Engine Bölüm 2 Docker Serisi #4 — Docker Compose Serinin bu bölümünde Docker Machine’den ve teknoloji camiasının bu sıralar çok sık duyduğu Docker Swarm’dan bahsedeceğim. Swarm konusu derya deniz olduğundan konuyu 2 ayrı bölüm halinde işleyeceğim. İlk bölümde Docker Machine’den bahsedip Swarm’a giriş yapacağız. İkinci bölümdeyse Swarm’ın, makine topluluklarının yönetiminde nasıl kolaylıklar sağladığını; örnek bir projenin makinelere dağıtılması ve ölçeklenmesiyle göreceğiz!\nDocker Machine Nedir? Diyelim ki kendi makinenizde ya da bulutta (cloud) bir Docker makine ağı (cluster) kurmak istiyorsunuz. Eskiden bunu nasıl yapardık? Gelin kendi makinemizde (Virtualbox kullandığımızı varsayarak) yapacak olsaydık neler yapacaktık; bir gözatalım:\nKuracağımız işletim sisteminin disk imajını (ISO) indirilmesi Virtualbox’ta N tane VM yaratılması ve her birinin ayarlarını düzenlenmesi (disk, bellek, işletim sistemi imajı vb.) Her bir VM’i başlatıp işletim sisteminin kurulması ve yapılandırılması (dil/zaman/klayve ayarları, disk ayarları vb.) Her bir VM için işletim sisteminin son güncellemelerinin yapılması ve ihtiyaç olabilecek paketlerin kurulumu Her bir VM için Docker paket deposu ayarlarının yapılması, Docker kurulumu ve yapılandırması (Docker Engine’in dinleyeceği bağlantı noktaları -port’lar-, atanacak etiketler -label’lar- vb.) DigitalOcean gibi bulut ortamlarında Docker’ın TLS ile çalışacak şekilde ayarlanması tavsiye ediliyor. Bu nedenle gerekli sertifikaların yaratılması ve Docker Engine’in TLS modunda çalıştırılması. Bu listede yapılacak işler, proje ihtiyacına göre uzayabilir. Elbette basit bir betikle (script) bu işler otomatize edilebilir. Peki farklı bulut ortamlarında da bu adımları yapmanız gerekirse? İşler zorlaşıyor, değil mi? 😉\nDocker Machine, tam olarak bunları çözüyor. İster kendi makineniz, isterseniz de AWS ya da DigitalOcean gibi bir bulut ortamı olsun; Docker Machine ile ihtiyacınız olan makineleri, istediğiniz özelliklerde ve istediğiniz adetle yaratabiliyorsunuz.\nVirtualbox ile Yerel Geliştirme Serinin daha önceki bölümlerinde söylediğim gibi; eğer Mac kullanıyorsanız, Docker for Mac kullanmanız en sağlıklısı. Ancak özel bir ihtiyaçtan ya da Swarm denemesi yapacağınız varsayımıyla Linux tabanlı Docker makinelerine ihtiyacınız varsa Docker Machine’i kullanabilirsiniz:\ndocker-machine create -d virtualbox \\ --engine-insecure-registry registry.local \\ --engine-label role=node \\ --engine-label role=manager \\ manager1 Parametrelerin anlamına bakalım;\n-d: Kullanılacak sürücüyü (driver) belirler. Virtualbox için virtualbox, AWS için amazonec2, DigitalOcean içinse digitalocean yazabilirsiniz. --engine-insecure-registry: Docker Hub dışında bir imaj deposu ve kendi ürettiğiniz bir SSL sertifikası kullanıyorsanız bu parametreyi kullanmalısınız. Böylece Docker Engine’in, imaj deposuna bağlanmaya çalışırken yaptığı güvenlik kontrollerini geçiştirmiş olacaksınız. --engine-label: Docker Engine’e etiketler atayarak özellikle Swarm modunda container’ların yerleşiminin bu etiketlere göre yapılmasını sağlayabilirsiniz. Tek makine açacaksanız tanımlamasanız da olur. role=node gibi tanımlar tamamen tercihe bağlı. Diyelim ki makineye s3fs kurdunuz. Bu durumda Docker Engine’e s3fs=enabled gibi bir etiket atayarak s3fs’ten faydalanan container’ların bu makinelere yerleşmesini sağlayabilirsiniz. Sondaki manager1 ise makinemize ulaşmak için kullanacağımız isim olacak. İlk makinemizi yarattıktan sonra docker-machine ls komutunu verirsek açık olan makinelerimiz listelenecektir. Daha önce farklı bulut ortamlarında makineler açtıysanız bu makineler de bu listelemede gözükecektir. Yani ortam bağımsız olarak Docker Machine ile açtığınız tüm makineleri görme imkanına sahipsiniz.\n--filter driver=virtualbox ya da --filter label=role=worker gibi parametrelerle listelemeyi kontrol edebiliyorsunuz.\nOluşturduğunuz makineleri silmek isterseniz;\ndocker-machine rm deneme komutuyla silebilirsiniz.\nMakinenin içine SSH ile girmek için;\ndocker-machine ssh deneme komutunu verebilirsiniz. İçine girdikten sonra docker komutlarıyla istediğiniz gibi çalışabilirsiniz. Alternatif olarak kendi makinenizden bu makineyi hedefleyerek çalışabilmek için;\neval $(docker-machine env deneme) komutunu verebilirsiniz. Bu komut, bulunduğunuz terminal oturumundaki DOCKER_HOST vb. değişkenlerin değerlerini, Docker Machine ile açtığınız makinenin değerleriyle değiştirerek, yazdığınız komutların o makine tarafından çalıştırılıp çıktısının sizin makinenizde gösterilmesini sağlar. Yani kendi makinenizden, uzaktaki makinede docker komutları çalıştırmış oluyorsunuz.\nTekrar kendi makinenizdeki Docker Engine’e dönmek isterseniz terminali açıp kapatabilir ya da;\neval $(docker-machine env -u) Protip: Docker Machine’i özellikle AWS vb. bulut ortamlarında makine açmak için kullanacaksanız 0.12.2+ kullanmanızı öneririm. Aradaki sürümlerde Ubuntu vb. dağıtımlardaki değişiklikler nedeniyle problem yaşayabilirsiniz.\nDocker Machine ile yapabileceğiniz diğer işlemler hakkında bilgi almak için docker-mackine komutunu hiç bir parametre olmadan vermeniz yeterli. Alt komutlarla ilgili bilgi almak içinse örneğin;\ndocker-machine create --help yazabilirsiniz.\nDocker ekosistemindeki değişiklikler son derece hızlı gerçekleşiyor ve zaman zaman alt projeler bu değişime ayak uyduramayabiliyor. Üst paragrafta söylediğim şekilde docker-machine’in desteklediği komutlara baktıysanız swarm’la ilgili de bazı komutlar içerdiğini göreceksiniz. Swarm oluşturmak için, aşağıda bahsedeceğim yeni yöntemleri kullanmanız daha iyi olur. Docker Machine ile swarm yöneticisi yaratmak ya da swarm ağına dahil olmak şimdiden demode sayılmaya başlamış bile!\nAWS’de Makine Açmak Docker Machine’in güçlü yanlarından birisi bulut ortamlarında da rahatlıkla makine açabiliyor olmanız. Bunun için AWS’de bir hesabınız ve bu hesaba ait anahtarların (token) elinizde olduğundan emin olun.\ndocker-machine create -d amazonec2 \\ --amazonec2-access-key erisim-anahtari \\ --amazonec2-secret-key cok-gizli-anahtar \\ --amazonec2-region eu-west-1 \\ --amazonec2-vpc-id ozel-vpc-id \\ --amazonec2-instance-type m4.large \\ --amazonec2-root-size 50 \\ --amazonec2-iam-instance-profile automated \\ --amazonec2-monitoring \\ --engine-label role=node n1 Kullandığım parametrelerin isimlerinden anlaşıldığını düşünüyorum. Sadece bazılarını neden özellikle yazdığımı paylaşayım;\n--amazonec2-vpc-id: Öntanımlı VPC ağını sildiyseniz ya da farklı bir VPC ağı kullanıyorsanız mutlaka belirtmeniz gerekiyor. --amazonec2-iam-instance-profile: Makineki container’lar aracılığıyla AWS üstündeki diğer kaynaklara (örneğin ben EC2 etiketlerini okumak için kullanıyorum) gizli anahtarlarınızı vermeden ulaşabilmek için kullanabilirsiniz. Docker Machine İpuçları 💡 Docker Machine, açtığı makinelere ait tüm verileri ve oluşturduğu SSL anahtarlarını ~/.docker/machine dizinine yazar. Bu dizine erişiminizi bir şekilde kaybederseniz, yarattığınız makinelere erişiminizi de kaybedersiniz. Ben çözüm olarak bu dizini Google Drive’a taşıyıp MACHINE_STORAGE_PATH çevresel değişkenini Google Drive’daki dizini gösterecek şekilde ayarladım. Docker Machine ile bulut ortamında makine açıyorsanız çok fazla parametre kullanmanız gerekiyor. Bu parametreleri sıkça kullanıyorsanız çevresel değişken karşılıklarını tanımlayarak öntanımlı hale getirebilirsiniz. Örneğin AWS hesap anahtarınızı (access key) AWS_ACCESS_KEY_ID değişkeni üstünden, kullandığınız imajı da AWS_AMI üstünden tanımlayabilirsiniz. Bu tür başka ne değişkenler olduğunu görmek için docker-machine create -d amazonec2 (farklı bulut ortamları için farklı sürücü adı verebilirsiniz) komutunu verebilirsiniz. Docker Machine’i bulut ortamında kullanmayı düşünüyorsanız ve servis keşfi (service discovery) ihtiyaçlarınız için de Docker’ı kullanmayı düşünüyorsanız, TLS sizin için bir problem oluşturabilir. Bu senaryoda yönetici makineler üstünde TLS’i kapatabilir ya da Docker Machine kullanmayabilirsiniz. Benim böyle ihtiyaçlarım olduğundan kurulumlarımı tektipleştirmek amacıyla kapsamlı bir betik yazdım. Docker Swarm Nedir? Bu yazıyı yazdığım sırada Docker CE 17.09.0-ce-mac35 (19611) var.\nSwarm, yönetici (master) ve yönetilen (worker) adı verilen makinelerin oluşturduğu bir ağdır (cluster). Bir Swarm ağı oluşturduğunuzda aslında bu ağda en az bir adet yönetici makine vardır ve yönetilenler bu ağa katılırlar. Herhangi bir anda, herhangi bir yönetilen makine, yönetici olarak atanabilir. Ancak ağda bağlı bulunan makineler, ağ ve DNS tanımları, çalışan servislerin kayıtları vb. tüm bilgiler (kısaca makine topluluğunun o anki durumu) yalnızca yöneticilerde tutulur ve bu bilgilere yalnızca yöneticiler üstünden ulaşılabilir. Son olarak Swarm yaratmak ya da mevcut bir Swarm ağına dahil olmak için Docker (≥ 1.12) kurulu olması yeterlidir. Swarm için birden fazla makineye ihtiyacım olduğundan burada anlattığım her şeyi Docker Machine ve Virtualbox aracılığıyla yarattığım sanal makineler üstünde göstereceğim.\nYazının geri kalanını benimle birlikte takip edebilmek için aşağıdaki 3 sanal makineyi yaratın:\ndocker-machine create -d virtualbox \\ --engine-label role=mgr \\ mgr1 docker-machine create -d virtualbox \\ --engine-label role=node \\ n1 docker-machine create -d virtualbox \\ --engine-label role=node \\ n2 role etiketiyle makineleri ikiye ayırdık. Deneme yapmamız nedeniyle yalnızca 1 yönetici (role=mgr) ve 2 yönetilen (role=node) makinemiz var. Gerçek ortamda ise minimum üç (tekil numara olması) yöneticiniz olması tavsiye ediliyor. Her yönetici, aynı zamanda yönetilen de olabiliyor. Yani yönetici makineleriniz, ağın durumunu tutmakla birlikte üstüne atacağınız bir kaç container’ı da çalıştırmaktan geri kalmayacaktır. 🙂\nMakinelerin hepsini oluşturduktan sonra şöyle bir şey görmeliyiz:\nMakinelerimiz hazır olduğuna göre, yöneticiye bağlanıp Swarm ağımızı yaratmaya başlayabiliriz:\n$ eval $(docker-machine env mgr1) $ docker swarm init --advertise-addr $(dm ip mgr1) Swarm initialized: current node (xwpzchdnz1fl1xq2shalhxexq) is now a manager. To add a worker to this swarm, run the following command: docker swarm join --token SWMTKN-1–1yavlpsjjd0xx6wujmngq6tvjcrpin5j3zm6kv4cwcyp2y1gad-04trkq963fymb0541nzbdkpbm 192.168.99.101:2377 To add a manager to this swarm, run ‘docker swarm join-token manager’ and follow the instructions. docker swarm init komutunu verdiğinizde mgr1 makinesinde Swarm ağınızı yaratmış bulunuyorsunuz. Bu makine üstünde docker info komutunu verirseniz şöyle bir şey görmelisiniz:\n$ docker info ... Swarm: active NodeID: xwpzchdnz1fl1xq2shalhxexq Is Manager: true ClusterID: 53x1z42eir65p7gvw1nc5utuy Managers: 1 Nodes: 1 ... Şimdi diğer makineleri yeni Swarm ağımıza bağlayalım:\n$ eval $(docker-machine env n1) docker swarm join — token SWMTKN-1–1yavlpsjjd0xx6wujmngq6tvjcrpin5j3zm6kv4cwcyp2y1gad-04trkq963fymb0541nzbdkpbm 192.168.99.101:2377 ⏎ This node joined a swarm as a worker. $ eval $(docker-machine env n2) docker swarm join — token SWMTKN-1–1yavlpsjjd0xx6wujmngq6tvjcrpin5j3zm6kv4cwcyp2y1gad-04trkq963fymb0541nzbdkpbm 192.168.99.101:2377 ⏎ This node joined a swarm as a worker. mgr1‘e geri gidip Swarm ağımıza bir bakalım:\ndocker node ls komutuyla yönetici makinenin bildiği tüm makineleri listeleyebilirsiniz.\nArtık kullanmaya hazır bir Swarm ağımız var! Devam etmeden önce Swarm terminolojisinden biraz bahsetmekte fayda var.\nDocker Swarm Terminolojisi Config: Container’larınıza ait yapılandırma dosyaları ya da dışarıdan verebileceğiniz çeşitli amaçlı dosyaları Docker Config aracılığıyla verebilirsiniz. Serinin ileriki bölümlerinde bu özelliği kullanıyor olacağız. Tanımladığınız tüm dosyalar (config’ler), Swarm ağı genelinde yalnızca onay verdiğiniz makineler tarafından erişilebilir durumda olacaktır. Secret: Herhangi bir amaçla kullandığınız ve gizli kalması gerekebilecek şifre, makine adresi, kullanıcı adı vb. bilgileri Docker Secret aracılığıyla güvenli bir şekilde saklayabilirsiniz. Tanımladığınız tüm sırlar (secret’lar), Swarm ağı genelinde yalnızca onay verdiğiniz makineler tarafından erişilebilir durumda olacaktır. Volume: Swarm kullanırken de tıpkı kendi makinenizde yapabildiğiniz gibi dışarıdan disk alanları bağlayabilirsiniz. Bunu yine ev sahibi makine aracılığıyla yapabileceğiniz gibi, eklentiler (plugins) aracılığıyla da yapabilirsiniz. Network: Swarm kullanmayı düşünüyorsanız, bu konu, bilmeniz gerekenlerin başında geliyor. Swarm’daki servis keşfi, Swarm’la birlikte yaratılan alt ağlara (ve bunlara bağlı IP havuzları) ve servislerle oluşturulan DNS kayıtlarına dayanıyor. Swarm’ı anlatırken bu konuya da özel olarak değiniyor olacağım. Service: Aynı container’dan bir veya daha fazlasının, ayarlarıyla birlikte gruplanmasına servis adı veriliyor. Örneğin bir MySQL container’ınız varsa; bu container’dan kaç tane çalışacağını, hangi makinelere, hangi kurallarla yerleştirileceğini, kullanılacak disk alanlarını, dışarıya açılacak bağlantı noktalarını, çevresel değişkenlerini ve daha bir çok ayarını servis içerisinde tanımlayabiliyoruz. Stack: Servislerin, ağların ve disk alanlarının, yapılandırma dosyaları ve sır tanımlarının oluşturduğu daha büyük gruba stack diyoruz. Örneğin, MySQL veritabanıyla konuşan bir uygulamanız varsa; uygulamanızı ve veritabanını bir stack içerisinde tanımlayıp rahatlıkla yönetebilirsiniz. Stack yardımıyla saniyeler içerisinde uygulamanızı yayına alabilir, kaldırabilir ya da aşağı/yukarı ölçekleyebilirsiniz. Docker Swarm Demo #1 İlk denememizi basit tutalım. tutum/hello-world imajından 2 tane ayağa kaldırarak, Swarm’ın basitçe nasıl çalıştığını görelim:\ndocker service create -d --name helloworld \\ --constraint engine.labels.role==node \\ -p 80:80 \\ --replicas 2 \\ tutum/hello-world Yukarıdaki komutla; tutum/hello-world servisini, yalnızca node rolündeki makinelere, toplamda 2 container olacak ve 80. bağlantı noktasını dışarıya açacak şekilde “dağıtıyoruz” (schedule). Bu komutu çalıştırdığınızda servise ait tanımlayıcıyı (Service ID) dönecektir. Dilerseniz bu tanımlayıcıyı ya da servisin ismini vererek sorgulama yapabilirsiniz:\ndocker service komutlarıyla “deploy” ettiğimiz servislerimizi, çalıştıkları makineler ve durum bilgileriyle görebiliyoruz.\nBen makineleri Virtualbox’da yarattığımda aldığım IP’ler şöyleymiş:\nmgr1: 192.168.99.101 n1: 192.168.99.102 n2: 192.168.99.103 Yeni servisimizi test edelim mi? 🤞🏻\nHangi makineye istek attığımı farkettiniz mi? 192.168.99.101! Yani mgr1! E hani sadece rolü node olan makinelere yerleştirmiştik servisi? 😳 Şimdi arka arkaya defalarca kez sayfayı yenileyin. “My hostname is” ifadesinin karşısındaki tanımlayıcının sürekli değiştiğini göreceksiniz. Aynı IP’ye istek atıyoruz ama farklı cevaplar alıyoruz. Servisimiz bir de yük dengeleme yapıyor?! 😮\nBir üstteki ekran görüntüsünde açıkça görüldüğü gibi; aslında servislerimizden 2 adet var ve yalnızca rolü node olan n1 ve n2 makinelerine yerleştirilmiş durumda. Peki nasıl oluyor da mgr1 makinesine istek atınca cevap alıyoruz? Cevap: ingress ağı! Docker 1.12+ ile gelen bu özellik sayesinde eğer bir servis, dışarı herhangi bir bağlantı noktası açarsa, bu bağlantı noktası tüm makinelerde açılır ve gelen istekler hangi makineye gelirse gelsin Swarm üzerinde o servisi çalıştıran makinelere yönlendirilir. Etkileyici, değil mi? 👏🏻👏🏻👏🏻\ningress ağı sayesinde uygulamamıza her makine üstünden erişilebiliyor! 👍🏻\nÜstteki diagram’da, tüm VM’lerin üstünde bir yük dengeleyici (LB) olduğunu varsayalım. Bir şekilde Swarm içerisindeki tüm makinelerin adresini LB’e ekleyebilirsek; tek bir noktadan uygulamamıza ölçeklenebilir bir şekilde ulaşabilir hale gelmiş oluyoruz. Diyelim ki; uygulamamız bu şekilde çalışırken çok fazla istek gelmeye başladı ve birer container’a daha ihtiyacımız var. Tek yapmamız gereken:\nBir şey dikkatinizi çekti mi? Yalnızca 2 node makinemiz var ve bu nedenle aynı servisten her makinede artık iki adet çalışmaya başladı. Peki ama 80. bağlantı noktasını hala nasıl dinliyoruz? Sürekli istek atarsanız, yukarıdaki ekran görüntüsünün de teyid ettiği şekilde, 4 tane container’ın da başarılı şekilde çalıştığını göreceksiniz.\nCevabı aslında yukarıdaki diyagram’da! Ingress ağı her zaman mevcut ve herhangi bir ayar yapmanıza gerek kalmaksızın, servisleriniz için başlatılan her container’a bu ağın IP havuzundan farklı bir adres veriliyor. Swarm içerisinde çalışan yük dengeleyiciler, her makinede dinlenen 80. bağlantı noktasının, hangi container’lara yönlendirileceğini yaptığınız servis tanımından dolayı biliyorlar ve otomatik olarak istekleri yönlendiriyorlar!\nn1 ya da n2‘ye bağlanıp container’ları rastgele öldürmeyi deneyin. Swarm, otomatik olarak yeni container’lar başlatacak ve ölçeklenebilirlik için ayarladığınız “minimum 4 container olsun” kuralını sağlamaya devam edecektir. 🎉\nServisinize ait imajı (örneğin uygulamanızın yeni sürümü çıktığında), çevresel değişkenleri, yapılandırma ya da sır dosyalarını, yerleşim ayarlarını ve diğer pek çok ayarı, servisinizi kapatmak zorunda kalmadan ya da herhangi bir servis dışı durum oluşmadan güncelleyebilirsiniz:\ndocker service update -d \\ --env-add server.port=8080 --label-add foo=bar \\ helloworld Değiştirebileceğiniz ayarlarla ilgili daha detaylı bilgi almak için;\ndocker service update --help komutunu kullanabilirsiniz. Yaptığınız değişikliklerde bir problem oluşması halinde bir önceki kararlı duruma geri dönmek için\ndocker service rollback helloworld komutunu kullanabilirsiniz.\nServislerin güçlü özelliklerinden bir diğeri ise tüm container’ların log kayıtlarını bir arada görme şansı vermesi:\ndocker service logs --tail 10 -f helloworld Kişisel fikrimi sorarsanız; bu özellik oldukça işe yarıyor olmakla beraber gerçek ortamda çalışan servisler için pek yeterli olmuyor. Birden fazla makinenin kayıtlarını bir araya topladığınızdan birbirine girmiş karman çorman kayıtlarla karşılaşabiliyorsunuz. Ancak Docker’ın log sürücüleri üstünden bu kayıtları logstash vb. servislerle paylaşabildiğini düşünürsek çok da mühim değil.\nKüçük ve fazla bağımlılıkları olmayan projelerinizi yalnızca docker service komutlarıyla sunuculara dağıtabilir ve ölçekleyebilirsiniz. Daha büyük ölçekli projeler için yapılması gerekenleri serinin bir sonraki yazısında ele alacağım.\nBilgisayarınızın kaynaklarını boş yere harcamamak için oluşturduğunuz servisi;\ndocker service rm helloworld komutuyla, Docker Makine ile yarattığınız VM’leri ise;\ndocker-machine rm mgr1 n1 n2 komutuyla silebilirsiniz.\nBu bölümünün de sonuna geldik. Bir sonraki bölüm olan “Docker Serisi #5 — Docker Machine \u0026 Swarm Bölüm 2”‘de görüşmek dileğiyle!\nGidişâta göre bu planda zaman zaman değişiklikler yapacak olsam da serinin tüm bölümlerinin planına şuradan ulaşabilirsiniz.\n",
  "wordCount" : "2262",
  "inLanguage": "tr",
  "datePublished": "2017-10-30T00:00:00Z",
  "dateModified": "2021-04-26T00:02:59+03:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://alperkan.at/tr/2017/10/docker-serisi-5/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Alper Kanat",
    "logo": {
      "@type": "ImageObject",
      "url": "https://alperkan.at/favicon.ico"
    }
  }
}
</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://alperkan.at/tr/ accesskey=h title="Alper Kanat (Alt + H)">Alper Kanat</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://alperkan.at/ title=🇬🇧 aria-label=🇬🇧>En</a></li></ul></span></div><ul id=menu><li><a href=https://alperkan.at/tr/arsiv title=arşiv><span>arşiv</span></a></li><li><a href=https://alperkan.at/tr/tags title=etiketler><span>etiketler</span></a></li><li><a href=https://alperkan.at/tr/hakkimda title=hakkımda><span>hakkımda</span></a></li><li><a href=https://github.com/tunix/notebook title=notlarım><span>notlarım</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Docker Serisi #5 -- Docker Machine & Swarm Bölüm 1</h1><div class=post-meta>October 30, 2017</div></header><div class=post-content><ol start=5><li>bölüme hoşgeldiniz! 🤘🏻 Serinin önceki bölümlerine ulaşmak için aşağıdaki bağlantıları kullanabilirsiniz:</li></ol><ul><li><a href=https://alperkan.at/tr/2016/07/docker-serisi-1/>Docker Serisi #1</a></li><li><a href=https://alperkan.at/tr/2016/09/docker-serisi-2/>Docker Serisi #2 — Docker Engine Bölüm 1</a></li><li><a href=https://alperkan.at/tr/2016/10/docker-serisi-3/>Docker Serisi #3 — Docker Engine Bölüm 2</a></li><li><a href=https://alperkan.at/tr/2017/03/docker-serisi-4/>Docker Serisi #4 — Docker Compose</a></li></ul><p>Serinin bu bölümünde Docker Machine’den ve teknoloji camiasının bu sıralar çok sık duyduğu Docker Swarm’dan
bahsedeceğim. Swarm konusu derya deniz olduğundan konuyu 2 ayrı bölüm halinde işleyeceğim. İlk bölümde Docker
Machine’den bahsedip Swarm’a giriş yapacağız. İkinci bölümdeyse Swarm’ın, makine topluluklarının yönetiminde nasıl
kolaylıklar sağladığını; örnek bir projenin makinelere dağıtılması ve ölçeklenmesiyle göreceğiz!</p><hr><h3 id=docker-machine-nedir>Docker Machine Nedir?<a hidden class=anchor aria-hidden=true href=#docker-machine-nedir>#</a></h3><p>Diyelim ki kendi makinenizde ya da bulutta (cloud) bir Docker makine ağı (cluster) kurmak istiyorsunuz. Eskiden bunu
nasıl yapardık? Gelin kendi makinemizde (Virtualbox kullandığımızı varsayarak) yapacak olsaydık neler yapacaktık; bir
gözatalım:</p><ul><li>Kuracağımız işletim sisteminin disk imajını (ISO) indirilmesi</li><li>Virtualbox’ta N tane VM yaratılması ve her birinin ayarlarını düzenlenmesi (disk, bellek, işletim sistemi imajı vb.)</li><li>Her bir VM’i başlatıp işletim sisteminin kurulması ve yapılandırılması (dil/zaman/klayve ayarları, disk ayarları vb.)</li><li>Her bir VM için işletim sisteminin son güncellemelerinin yapılması ve ihtiyaç olabilecek paketlerin kurulumu</li><li>Her bir VM için Docker paket deposu ayarlarının yapılması, Docker kurulumu ve yapılandırması (Docker Engine’in
dinleyeceği bağlantı noktaları -port’lar-, atanacak etiketler -label’lar- vb.)</li><li>DigitalOcean gibi bulut ortamlarında Docker’ın TLS ile çalışacak şekilde ayarlanması tavsiye ediliyor. Bu nedenle
gerekli sertifikaların yaratılması ve Docker Engine’in TLS modunda çalıştırılması.</li></ul><p>Bu listede yapılacak işler, proje ihtiyacına göre uzayabilir. Elbette basit bir betikle (script) bu işler otomatize
edilebilir. Peki farklı bulut ortamlarında da bu adımları yapmanız gerekirse? İşler zorlaşıyor, değil mi? 😉</p><p>Docker Machine, tam olarak bunları çözüyor. İster kendi makineniz, isterseniz de AWS ya da DigitalOcean gibi bir bulut
ortamı olsun; Docker Machine ile ihtiyacınız olan makineleri, istediğiniz özelliklerde ve istediğiniz adetle
yaratabiliyorsunuz.</p><h4 id=virtualbox-ile-yerel-geliştirme>Virtualbox ile Yerel Geliştirme<a hidden class=anchor aria-hidden=true href=#virtualbox-ile-yerel-geliştirme>#</a></h4><p>Serinin daha önceki bölümlerinde söylediğim gibi; eğer Mac kullanıyorsanız, Docker for Mac kullanmanız en sağlıklısı.
Ancak özel bir ihtiyaçtan ya da Swarm denemesi yapacağınız varsayımıyla Linux tabanlı Docker makinelerine ihtiyacınız
varsa Docker Machine’i kullanabilirsiniz:</p><pre tabindex=0><code>docker-machine create -d virtualbox \
    --engine-insecure-registry registry.local \
    --engine-label role=node \
    --engine-label role=manager \
    manager1
</code></pre><p>Parametrelerin anlamına bakalım;</p><ul><li><code>-d</code>: Kullanılacak sürücüyü (driver) belirler. Virtualbox için <code>virtualbox</code>, AWS için <code>amazonec2</code>, DigitalOcean
içinse <code>digitalocean</code> yazabilirsiniz.</li><li><code>--engine-insecure-registry</code>: Docker Hub dışında bir imaj deposu ve kendi ürettiğiniz bir SSL sertifikası
kullanıyorsanız bu parametreyi kullanmalısınız. Böylece Docker Engine’in, imaj deposuna bağlanmaya çalışırken yaptığı
güvenlik kontrollerini geçiştirmiş olacaksınız.</li><li><code>--engine-label</code>: Docker Engine’e etiketler atayarak özellikle Swarm modunda container’ların yerleşiminin bu
etiketlere göre yapılmasını sağlayabilirsiniz. Tek makine açacaksanız tanımlamasanız da olur. <code>role=node</code> gibi
tanımlar tamamen tercihe bağlı. Diyelim ki makineye s3fs kurdunuz. Bu durumda Docker Engine’e <code>s3fs=enabled</code> gibi
bir etiket atayarak s3fs’ten faydalanan container’ların bu makinelere yerleşmesini sağlayabilirsiniz.</li></ul><p>Sondaki <code>manager1</code> ise makinemize ulaşmak için kullanacağımız isim olacak. İlk makinemizi yarattıktan sonra
<code>docker-machine ls</code> komutunu verirsek açık olan makinelerimiz listelenecektir. Daha önce farklı bulut ortamlarında
makineler açtıysanız bu makineler de bu listelemede gözükecektir. Yani <em>ortam bağımsız</em> olarak Docker Machine ile
açtığınız tüm makineleri görme imkanına sahipsiniz.</p><figure><img loading=lazy src=docker_machine_ls_ciktisi.png alt="--filter driver=virtualbox ya da --filter label=role=worker gibi parametrelerle listelemeyi kontrol edebiliyorsunuz."><figcaption><p><code>--filter driver=virtualbox</code> ya da <code>--filter label=role=worker</code> gibi parametrelerle listelemeyi kontrol edebiliyorsunuz.</p></figcaption></figure><p>Oluşturduğunuz makineleri silmek isterseniz;</p><pre tabindex=0><code>docker-machine rm deneme
</code></pre><p>komutuyla silebilirsiniz.</p><p>Makinenin içine SSH ile girmek için;</p><pre tabindex=0><code>docker-machine ssh deneme
</code></pre><p>komutunu verebilirsiniz. İçine girdikten sonra docker komutlarıyla istediğiniz gibi çalışabilirsiniz. Alternatif olarak
kendi makinenizden bu makineyi hedefleyerek çalışabilmek için;</p><pre tabindex=0><code>eval $(docker-machine env deneme)
</code></pre><p>komutunu verebilirsiniz. Bu komut, bulunduğunuz terminal oturumundaki <code>DOCKER_HOST</code> vb. değişkenlerin değerlerini,
Docker Machine ile açtığınız makinenin değerleriyle değiştirerek, yazdığınız komutların o makine tarafından
çalıştırılıp çıktısının sizin makinenizde gösterilmesini sağlar. Yani kendi makinenizden, uzaktaki makinede docker
komutları çalıştırmış oluyorsunuz.</p><p>Tekrar kendi makinenizdeki Docker Engine’e dönmek isterseniz terminali açıp kapatabilir ya da;</p><pre tabindex=0><code>eval $(docker-machine env -u)
</code></pre><blockquote><p>Protip: Docker Machine’i özellikle AWS vb. bulut ortamlarında makine açmak için kullanacaksanız 0.12.2+ kullanmanızı
öneririm. Aradaki sürümlerde Ubuntu vb. dağıtımlardaki değişiklikler nedeniyle problem yaşayabilirsiniz.</p></blockquote><p>Docker Machine ile yapabileceğiniz diğer işlemler hakkında bilgi almak için <code>docker-mackine</code> komutunu hiç bir parametre
olmadan vermeniz yeterli. Alt komutlarla ilgili bilgi almak içinse örneğin;</p><pre tabindex=0><code>docker-machine create --help
</code></pre><p>yazabilirsiniz.</p><p>Docker ekosistemindeki değişiklikler son derece hızlı gerçekleşiyor ve zaman zaman alt projeler bu değişime ayak
uyduramayabiliyor. Üst paragrafta söylediğim şekilde <code>docker-machine</code>’in desteklediği komutlara baktıysanız swarm’la
ilgili de bazı komutlar içerdiğini göreceksiniz. Swarm oluşturmak için, aşağıda bahsedeceğim yeni yöntemleri
kullanmanız daha iyi olur. Docker Machine ile swarm yöneticisi yaratmak ya da swarm ağına dahil olmak şimdiden demode
sayılmaya başlamış bile!</p><h4 id=awsde-makine-açmak>AWS’de Makine Açmak<a hidden class=anchor aria-hidden=true href=#awsde-makine-açmak>#</a></h4><p>Docker Machine’in güçlü yanlarından birisi bulut ortamlarında da rahatlıkla makine açabiliyor olmanız. Bunun için
AWS’de bir hesabınız ve bu hesaba ait anahtarların (token) elinizde olduğundan emin olun.</p><pre tabindex=0><code>docker-machine create -d amazonec2 \
    --amazonec2-access-key erisim-anahtari \
    --amazonec2-secret-key cok-gizli-anahtar \
    --amazonec2-region eu-west-1 \
    --amazonec2-vpc-id ozel-vpc-id \
    --amazonec2-instance-type m4.large \
    --amazonec2-root-size 50 \
    --amazonec2-iam-instance-profile automated \
    --amazonec2-monitoring \
    --engine-label role=node n1
</code></pre><p>Kullandığım parametrelerin isimlerinden anlaşıldığını düşünüyorum. Sadece bazılarını neden özellikle yazdığımı
paylaşayım;</p><ul><li><code>--amazonec2-vpc-id</code>: Öntanımlı VPC ağını sildiyseniz ya da farklı bir VPC ağı kullanıyorsanız mutlaka belirtmeniz
gerekiyor.</li><li><code>--amazonec2-iam-instance-profile</code>: Makineki container’lar aracılığıyla AWS üstündeki diğer kaynaklara (örneğin ben
EC2 etiketlerini okumak için kullanıyorum) gizli anahtarlarınızı vermeden ulaşabilmek için kullanabilirsiniz.</li></ul><h4 id=docker-machine-ipuçları->Docker Machine İpuçları 💡<a hidden class=anchor aria-hidden=true href=#docker-machine-ipuçları->#</a></h4><ul><li>Docker Machine, açtığı makinelere ait tüm verileri ve oluşturduğu SSL anahtarlarını <code>~/.docker/machine</code> dizinine
yazar. Bu dizine erişiminizi bir şekilde kaybederseniz, yarattığınız makinelere erişiminizi de kaybedersiniz. Ben
çözüm olarak bu dizini Google Drive’a taşıyıp <code>MACHINE_STORAGE_PATH</code> çevresel değişkenini Google Drive’daki dizini
gösterecek şekilde ayarladım.</li><li>Docker Machine ile bulut ortamında makine açıyorsanız çok fazla parametre kullanmanız gerekiyor. Bu parametreleri
sıkça kullanıyorsanız çevresel değişken karşılıklarını tanımlayarak öntanımlı hale getirebilirsiniz. Örneğin AWS
hesap anahtarınızı (access key) <code>AWS_ACCESS_KEY_ID</code> değişkeni üstünden, kullandığınız imajı da <code>AWS_AMI</code> üstünden
tanımlayabilirsiniz. Bu tür başka ne değişkenler olduğunu görmek için <code>docker-machine create -d amazonec2</code> (farklı
bulut ortamları için farklı sürücü adı verebilirsiniz) komutunu verebilirsiniz.</li><li>Docker Machine’i bulut ortamında kullanmayı düşünüyorsanız ve servis keşfi (service discovery) ihtiyaçlarınız için
de Docker’ı kullanmayı düşünüyorsanız, TLS sizin için bir problem oluşturabilir. Bu senaryoda yönetici makineler
üstünde TLS’i kapatabilir ya da Docker Machine kullanmayabilirsiniz. Benim böyle ihtiyaçlarım olduğundan
kurulumlarımı tektipleştirmek amacıyla kapsamlı bir betik yazdım.</li></ul><hr><h3 id=docker-swarm-nedir>Docker Swarm Nedir?<a hidden class=anchor aria-hidden=true href=#docker-swarm-nedir>#</a></h3><figure><img loading=lazy src=docker_version_dialog.png alt="Bu yazıyı yazdığım sırada Docker CE 17.09.0-ce-mac35 (19611) var."><figcaption><p>Bu yazıyı yazdığım sırada Docker CE 17.09.0-ce-mac35 (19611) var.</p></figcaption></figure><p>Swarm, yönetici (master) ve yönetilen (worker) adı verilen makinelerin oluşturduğu bir ağdır (cluster). Bir Swarm ağı
oluşturduğunuzda aslında bu ağda en az bir adet yönetici makine vardır ve yönetilenler bu ağa katılırlar. Herhangi bir
anda, herhangi bir yönetilen makine, yönetici olarak atanabilir. Ancak ağda bağlı bulunan makineler, ağ ve DNS
tanımları, çalışan servislerin kayıtları vb. tüm bilgiler (kısaca makine topluluğunun o anki durumu) yalnızca
yöneticilerde tutulur ve bu bilgilere yalnızca yöneticiler üstünden ulaşılabilir. Son olarak Swarm yaratmak ya da
mevcut bir Swarm ağına dahil olmak için Docker (≥ 1.12) kurulu olması yeterlidir. Swarm için birden fazla makineye
ihtiyacım olduğundan burada anlattığım her şeyi Docker Machine ve Virtualbox aracılığıyla yarattığım sanal makineler
üstünde göstereceğim.</p><p>Yazının geri kalanını benimle birlikte takip edebilmek için aşağıdaki 3 sanal makineyi yaratın:</p><pre tabindex=0><code>docker-machine create -d virtualbox \
    --engine-label role=mgr \
    mgr1

docker-machine create -d virtualbox \
    --engine-label role=node \
    n1

docker-machine create -d virtualbox \
    --engine-label role=node \
    n2
</code></pre><p><code>role</code> etiketiyle makineleri ikiye ayırdık. Deneme yapmamız nedeniyle yalnızca 1 yönetici (<code>role=mgr</code>) ve 2 yönetilen
(<code>role=node</code>) makinemiz var. Gerçek ortamda ise minimum üç (tekil numara olması) yöneticiniz olması tavsiye ediliyor.
Her yönetici, aynı zamanda yönetilen de olabiliyor. Yani yönetici makineleriniz, ağın durumunu tutmakla birlikte üstüne
atacağınız bir kaç container’ı da çalıştırmaktan geri kalmayacaktır. 🙂</p><p>Makinelerin hepsini oluşturduktan sonra şöyle bir şey görmeliyiz:</p><figure><img loading=lazy src=swarm_vm_yaratimi.png></figure><p>Makinelerimiz hazır olduğuna göre, yöneticiye bağlanıp Swarm ağımızı yaratmaya başlayabiliriz:</p><pre tabindex=0><code>$ eval $(docker-machine env mgr1)

$ docker swarm init --advertise-addr $(dm ip mgr1)
Swarm initialized: current node (xwpzchdnz1fl1xq2shalhxexq) is now a manager.

To add a worker to this swarm, run the following command:

docker swarm join --token SWMTKN-1–1yavlpsjjd0xx6wujmngq6tvjcrpin5j3zm6kv4cwcyp2y1gad-04trkq963fymb0541nzbdkpbm 192.168.99.101:2377

To add a manager to this swarm, run ‘docker swarm join-token manager’ and follow the instructions.
</code></pre><p><code>docker swarm init</code> komutunu verdiğinizde mgr1 makinesinde Swarm ağınızı yaratmış bulunuyorsunuz. Bu makine üstünde
<code>docker info</code> komutunu verirseniz şöyle bir şey görmelisiniz:</p><pre tabindex=0><code>$ docker info
...
Swarm: active
NodeID: xwpzchdnz1fl1xq2shalhxexq
Is Manager: true
ClusterID: 53x1z42eir65p7gvw1nc5utuy
Managers: 1
Nodes: 1
...
</code></pre><p>Şimdi diğer makineleri yeni Swarm ağımıza bağlayalım:</p><pre tabindex=0><code>$ eval $(docker-machine env n1)

docker swarm join — token SWMTKN-1–1yavlpsjjd0xx6wujmngq6tvjcrpin5j3zm6kv4cwcyp2y1gad-04trkq963fymb0541nzbdkpbm 192.168.99.101:2377 ⏎
This node joined a swarm as a worker.

$ eval $(docker-machine env n2)

docker swarm join — token SWMTKN-1–1yavlpsjjd0xx6wujmngq6tvjcrpin5j3zm6kv4cwcyp2y1gad-04trkq963fymb0541nzbdkpbm 192.168.99.101:2377 ⏎
This node joined a swarm as a worker.
</code></pre><p><code>mgr1</code>&lsquo;e geri gidip Swarm ağımıza bir bakalım:</p><figure><img loading=lazy src=swarm_node_list.png alt="docker node ls komutuyla yönetici makinenin bildiği tüm makineleri listeleyebilirsiniz."><figcaption><p><code>docker node ls</code> komutuyla yönetici makinenin bildiği tüm makineleri listeleyebilirsiniz.</p></figcaption></figure><p>Artık kullanmaya hazır bir Swarm ağımız var! Devam etmeden önce Swarm terminolojisinden biraz bahsetmekte fayda var.</p><h4 id=docker-swarm-terminolojisi>Docker Swarm Terminolojisi<a hidden class=anchor aria-hidden=true href=#docker-swarm-terminolojisi>#</a></h4><ul><li><strong>Config</strong>: Container’larınıza ait yapılandırma dosyaları ya da dışarıdan verebileceğiniz çeşitli amaçlı dosyaları
Docker Config aracılığıyla verebilirsiniz. Serinin ileriki bölümlerinde bu özelliği kullanıyor olacağız.
Tanımladığınız tüm dosyalar (config’ler), Swarm ağı genelinde yalnızca onay verdiğiniz makineler tarafından
erişilebilir durumda olacaktır.</li><li><strong>Secret</strong>: Herhangi bir amaçla kullandığınız ve gizli kalması gerekebilecek şifre, makine adresi, kullanıcı adı vb.
bilgileri Docker Secret aracılığıyla güvenli bir şekilde saklayabilirsiniz. Tanımladığınız tüm sırlar (secret’lar),
Swarm ağı genelinde yalnızca onay verdiğiniz makineler tarafından erişilebilir durumda olacaktır.</li><li><strong>Volume</strong>: Swarm kullanırken de tıpkı kendi makinenizde yapabildiğiniz gibi dışarıdan disk alanları
bağlayabilirsiniz. Bunu yine ev sahibi makine aracılığıyla yapabileceğiniz gibi, eklentiler (plugins) aracılığıyla
da yapabilirsiniz.</li><li><strong>Network</strong>: Swarm kullanmayı düşünüyorsanız, bu konu, bilmeniz gerekenlerin başında geliyor. Swarm’daki servis
keşfi, Swarm’la birlikte yaratılan alt ağlara (ve bunlara bağlı IP havuzları) ve servislerle oluşturulan DNS
kayıtlarına dayanıyor. Swarm’ı anlatırken bu konuya da özel olarak değiniyor olacağım.</li><li><strong>Service</strong>: Aynı container’dan bir veya daha fazlasının, ayarlarıyla birlikte gruplanmasına servis adı veriliyor.
Örneğin bir MySQL container’ınız varsa; bu container’dan kaç tane çalışacağını, hangi makinelere, hangi kurallarla
yerleştirileceğini, kullanılacak disk alanlarını, dışarıya açılacak bağlantı noktalarını, çevresel değişkenlerini ve
daha bir çok ayarını servis içerisinde tanımlayabiliyoruz.</li><li><strong>Stack</strong>: Servislerin, ağların ve disk alanlarının, yapılandırma dosyaları ve sır tanımlarının oluşturduğu daha
büyük gruba stack diyoruz. Örneğin, MySQL veritabanıyla konuşan bir uygulamanız varsa; uygulamanızı ve veritabanını
bir stack içerisinde tanımlayıp rahatlıkla yönetebilirsiniz. Stack yardımıyla saniyeler içerisinde uygulamanızı
yayına alabilir, kaldırabilir ya da aşağı/yukarı ölçekleyebilirsiniz.</li></ul><h4 id=docker-swarm-demo-1>Docker Swarm Demo #1<a hidden class=anchor aria-hidden=true href=#docker-swarm-demo-1>#</a></h4><p>İlk denememizi basit tutalım. <code>tutum/hello-world</code> imajından 2 tane ayağa kaldırarak, Swarm’ın basitçe nasıl çalıştığını
görelim:</p><pre tabindex=0><code>docker service create -d --name helloworld \
    --constraint engine.labels.role==node \
    -p 80:80 \
    --replicas 2 \
    tutum/hello-world
</code></pre><p>Yukarıdaki komutla; <code>tutum/hello-world</code> servisini, yalnızca <code>node</code> rolündeki makinelere, toplamda 2 container olacak
ve 80. bağlantı noktasını dışarıya açacak şekilde &ldquo;dağıtıyoruz&rdquo; (schedule). Bu komutu çalıştırdığınızda servise ait
tanımlayıcıyı (Service ID) dönecektir. Dilerseniz bu tanımlayıcıyı ya da servisin ismini vererek sorgulama
yapabilirsiniz:</p><figure><img loading=lazy src=docker_service_komut_ciktilari.png alt="docker service komutlarıyla &amp;ldquo;deploy&amp;rdquo; ettiğimiz servislerimizi, çalıştıkları makineler ve durum bilgileriyle görebiliyoruz."><figcaption><p><code>docker service</code> komutlarıyla &ldquo;deploy&rdquo; ettiğimiz servislerimizi, çalıştıkları makineler ve durum bilgileriyle görebiliyoruz.</p></figcaption></figure><p>Ben makineleri Virtualbox’da yarattığımda aldığım IP’ler şöyleymiş:</p><ul><li><em>mgr1</em>: 192.168.99.101</li><li><em>n1</em>: 192.168.99.102</li><li><em>n2</em>: 192.168.99.103</li></ul><p>Yeni servisimizi test edelim mi? 🤞🏻</p><figure><img loading=lazy src=servis_tarayici_testi.png></figure><p>Hangi makineye istek attığımı farkettiniz mi? 192.168.99.<strong>101</strong>! Yani <code>mgr1</code>! E hani sadece rolü <code>node</code> olan
makinelere yerleştirmiştik servisi? 😳 Şimdi arka arkaya defalarca kez sayfayı yenileyin. &ldquo;My hostname is&rdquo; ifadesinin
karşısındaki tanımlayıcının sürekli değiştiğini göreceksiniz. Aynı IP’ye istek atıyoruz ama farklı cevaplar alıyoruz.
Servisimiz bir de yük dengeleme yapıyor?! 😮</p><p>Bir üstteki ekran görüntüsünde açıkça görüldüğü gibi; aslında servislerimizden 2 adet var ve yalnızca rolü <code>node</code> olan
<code>n1</code> ve <code>n2</code> makinelerine yerleştirilmiş durumda. Peki nasıl oluyor da <code>mgr1</code> makinesine istek atınca cevap alıyoruz?
Cevap: <strong>ingress</strong> ağı! Docker 1.12+ ile gelen bu özellik sayesinde eğer bir servis, dışarı herhangi bir bağlantı
noktası açarsa, bu bağlantı noktası tüm makinelerde açılır ve gelen istekler hangi makineye gelirse gelsin Swarm
üzerinde o servisi çalıştıran makinelere yönlendirilir. Etkileyici, değil mi? 👏🏻👏🏻👏🏻</p><figure><img loading=lazy src=swarm_cluster_semasi.jpeg alt="ingress ağı sayesinde uygulamamıza her makine üstünden erişilebiliyor! 👍🏻"><figcaption><p><strong>ingress</strong> ağı sayesinde uygulamamıza her makine üstünden erişilebiliyor! 👍🏻</p></figcaption></figure><p>Üstteki diagram’da, tüm VM’lerin üstünde bir yük dengeleyici (LB) olduğunu varsayalım. Bir şekilde Swarm içerisindeki
tüm makinelerin adresini LB’e ekleyebilirsek; tek bir noktadan uygulamamıza ölçeklenebilir bir şekilde ulaşabilir hale
gelmiş oluyoruz. Diyelim ki; uygulamamız bu şekilde çalışırken çok fazla istek gelmeye başladı ve birer container’a
daha ihtiyacımız var. Tek yapmamız gereken:</p><figure><img loading=lazy src=swarm_scale_ps_ciktisi.png></figure><p>Bir şey dikkatinizi çekti mi? Yalnızca 2 <code>node</code> makinemiz var ve bu nedenle aynı servisten her makinede artık iki adet
çalışmaya başladı. Peki ama 80. bağlantı noktasını hala nasıl dinliyoruz? Sürekli istek atarsanız, yukarıdaki ekran
görüntüsünün de teyid ettiği şekilde, 4 tane container’ın da başarılı şekilde çalıştığını göreceksiniz.</p><p>Cevabı aslında yukarıdaki diyagram’da! Ingress ağı her zaman mevcut ve herhangi bir ayar yapmanıza gerek kalmaksızın,
servisleriniz için başlatılan her container’a bu ağın IP havuzundan farklı bir adres veriliyor. Swarm içerisinde
çalışan yük dengeleyiciler, her makinede dinlenen 80. bağlantı noktasının, hangi container’lara yönlendirileceğini
yaptığınız servis tanımından dolayı biliyorlar ve otomatik olarak istekleri yönlendiriyorlar!</p><p><code>n1</code> ya da <code>n2</code>&lsquo;ye bağlanıp container&rsquo;ları rastgele öldürmeyi deneyin. Swarm, otomatik olarak yeni container&rsquo;lar
başlatacak ve ölçeklenebilirlik için ayarladığınız &ldquo;minimum 4 container olsun&rdquo; kuralını sağlamaya devam edecektir. 🎉</p><p>Servisinize ait imajı (örneğin uygulamanızın yeni sürümü çıktığında), çevresel değişkenleri, yapılandırma ya da sır
dosyalarını, yerleşim ayarlarını ve diğer pek çok ayarı, servisinizi kapatmak zorunda kalmadan ya da herhangi bir
servis dışı durum oluşmadan güncelleyebilirsiniz:</p><pre tabindex=0><code>docker service update -d \
    --env-add server.port=8080
    --label-add foo=bar \
    helloworld
</code></pre><p>Değiştirebileceğiniz ayarlarla ilgili daha detaylı bilgi almak için;</p><pre tabindex=0><code>docker service update --help
</code></pre><p>komutunu kullanabilirsiniz. Yaptığınız değişikliklerde bir problem oluşması halinde bir önceki kararlı duruma geri
dönmek için</p><pre tabindex=0><code>docker service rollback helloworld
</code></pre><p>komutunu kullanabilirsiniz.</p><p>Servislerin güçlü özelliklerinden bir diğeri ise tüm container’ların log kayıtlarını bir arada görme şansı vermesi:</p><pre tabindex=0><code>docker service logs --tail 10 -f helloworld
</code></pre><p>Kişisel fikrimi sorarsanız; bu özellik oldukça işe yarıyor olmakla beraber gerçek ortamda çalışan servisler için pek
yeterli olmuyor. Birden fazla makinenin kayıtlarını bir araya topladığınızdan birbirine girmiş karman çorman kayıtlarla
karşılaşabiliyorsunuz. Ancak Docker’ın log sürücüleri üstünden bu kayıtları
<a href=https://www.elastic.co/products/logstash>logstash</a> vb. servislerle paylaşabildiğini düşünürsek çok da mühim değil.</p><p>Küçük ve fazla bağımlılıkları olmayan projelerinizi yalnızca <code>docker service</code> komutlarıyla sunuculara dağıtabilir ve
ölçekleyebilirsiniz. Daha büyük ölçekli projeler için yapılması gerekenleri serinin bir sonraki yazısında ele alacağım.</p><p>Bilgisayarınızın kaynaklarını boş yere harcamamak için oluşturduğunuz servisi;</p><pre tabindex=0><code>docker service rm helloworld
</code></pre><p>komutuyla, Docker Makine ile yarattığınız VM’leri ise;</p><pre tabindex=0><code>docker-machine rm mgr1 n1 n2
</code></pre><p>komutuyla silebilirsiniz.</p><hr><p>Bu bölümünün de sonuna geldik. Bir sonraki bölüm olan &ldquo;Docker Serisi #5 — Docker Machine & Swarm Bölüm 2&rdquo;&lsquo;de görüşmek
dileğiyle!</p><p>Gidişâta göre bu planda zaman zaman değişiklikler yapacak olsam da serinin tüm bölümlerinin planına
<a href=https://www.evernote.com/l/AB7CctYtJkpMUJsae1_3FgzIXgMY5MvFQhU>şuradan</a> ulaşabilirsiniz.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://alperkan.at/tr/tags/yaz%C4%B1l%C4%B1m/>yazılım</a></li><li><a href=https://alperkan.at/tr/tags/docker/>docker</a></li><li><a href=https://alperkan.at/tr/tags/docker-serisi/>docker serisi</a></li><li><a href=https://alperkan.at/tr/tags/container/>container</a></li><li><a href=https://alperkan.at/tr/tags/sanalla%C5%9Ft%C4%B1rma/>sanallaştırma</a></li><li><a href=https://alperkan.at/tr/tags/linux/>linux</a></li><li><a href=https://alperkan.at/tr/tags/devops/>devops</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://alperkan.at/tr/>Alper Kanat</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById("menu");menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>